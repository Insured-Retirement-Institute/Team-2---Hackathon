apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: alb
spec:
  controllerName: gateway.k8s.aws/alb
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: hack2future-gateway
spec:
  gatewayClassName: alb
  infrastructure:
    parametersRef:
      group: gateway.k8s.aws
      kind: LoadBalancerConfiguration
      name: hack2future-lb-config
  listeners:
    - name: http
      protocol: HTTP
      port: 80
      allowedRoutes:
        namespaces:
          from: Same
---
apiVersion: gateway.k8s.aws/v1beta1
kind: LoadBalancerConfiguration
metadata:
  name: hack2future-lb-config
spec:
  scheme: internet-facing
---
apiVersion: gateway.k8s.aws/v1beta1
kind: TargetGroupConfiguration
metadata:
  name: hack2future-tg-config
spec:
  targetReference:
    kind: Service
    name: hack2future
  defaultConfiguration:
    targetType: ip
    healthCheckConfig:
      healthCheckPath: /health
      healthCheckProtocol: HTTP
      healthyThresholdCount: 2
      unhealthyThresholdCount: 3
      healthCheckInterval: 30
      healthCheckTimeout: 5
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: api-route
spec:
  parentRefs:
    - name: hack2future-gateway
      sectionName: http
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /api
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /
      backendRefs:
        - name: hack2future
          port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: frontend-route
spec:
  parentRefs:
    - name: hack2future-gateway
      sectionName: http
  rules:
    - backendRefs:
        - name: hack2future-frontend
          port: 80
---
# Example: Add more services by creating additional HTTPRoutes
# Uncomment and modify to add agents service:
#
# apiVersion: gateway.networking.k8s.io/v1
# kind: HTTPRoute
# metadata:
#   name: agents-route
# spec:
#   parentRefs:
#     - name: hack2future-gateway
#       sectionName: http
#   rules:
#     - matches:
#         - path:
#             type: PathPrefix
#             value: /agents
#       filters:
#         - type: URLRewrite
#           urlRewrite:
#             path:
#               type: ReplacePrefixMatch
#               replacePrefixMatch: /
#       backendRefs:
#         - name: agents-service  # Change to your service name
#           port: 80
