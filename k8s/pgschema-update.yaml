# pgschema declarative schema migration Job
#
# Each run creates a uniquely-named Job (via generateName) so past runs are
# preserved and their logs remain inspectable.
#
# Preferred usage through mise:
#   mise run pgschema:plan-k8s       # preview changes
#   mise run pgschema:apply-k8s      # execute changes
#
# Manual usage:
#   kubectl create -f k8s/pgschema-update.yaml        # plan (default)
#   kubectl logs job/<job-name>                        # view output
apiVersion: batch/v1
kind: Job
metadata:
  generateName: pgschema-update-
  labels:
    app: pgschema-update
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: pgschema-update
    spec:
      restartPolicy: Never
      containers:
        - name: pgschema
          image: pgplex/pgschema:latest
          env:
            - name: PGHOST
              valueFrom:
                secretKeyRef:
                  name: hackdb-superuser
                  key: host
            - name: PGPORT
              valueFrom:
                secretKeyRef:
                  name: hackdb-superuser
                  key: port
            - name: PGUSER
              valueFrom:
                secretKeyRef:
                  name: hackdb-superuser
                  key: username
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: hackdb-superuser
                  key: password
            - name: PGDATABASE
              value: hackathon
            # "plan" (default, safe preview) or "apply" (executes changes)
            - name: PGSCHEMA_COMMAND
              value: plan
          command: ["sh", "-c"]
          args:
            - |
              set -e

              EXTRA_ARGS=""
              if [ "$PGSCHEMA_COMMAND" = "apply" ]; then
                EXTRA_ARGS="--auto-approve"
              fi

              echo "=== hackathon schema ==="
              pgschema $PGSCHEMA_COMMAND --file /schemas/main.sql --schema hackathon $EXTRA_ARGS
          volumeMounts:
            - name: database-schema
              mountPath: /schemas
              readOnly: true

      volumes:
        - name: database-schema
          configMap:
            name: pgschema-database
